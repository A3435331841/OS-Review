
# 第2章 操作系统结构详解

## 2.1 操作系统服务

操作系统为程序运行提供环境，并向程序及用户提供各种服务：

### 基本服务

1. **用户接口**
   * 命令行接口(CLI)：通过文本命令交互
   * 批处理接口：提前准备好一组命令集中执行
   * 图形用户接口(GUI)：通过可视化元素交互
2. **程序执行**
   * 将程序加载到内存并运行
   * 为程序分配必要的资源
   * 管理程序执行过程中的各种状态转换
3. **I/O操作**
   * 提供统一的I/O接口，抽象化底层硬件差异
   * 管理各种输入输出设备
   * 实现数据在内存与外部设备之间的传输
4. **文件系统操作**
   * 创建、删除、读取、写入文件
   * 管理文件的组织结构和存储方式
   * 提供文件访问权限控制
5. **通信**
   * 进程间通信(IPC)：同一系统内进程之间的信息交换
   * 网络通信：不同系统间的数据传输
   * 消息传递、共享内存等机制
6. **错误检测**
   * 监控系统运行状态
   * 检测并处理硬件错误
   * 处理程序运行中的异常情况
7. **资源分配**
   * CPU时间片分配
   * 内存空间分配
   * I/O设备分配
   * 确保多个任务能够合理共享系统资源
8. **统计**
   * 记录资源使用情况
   * 跟踪用户使用的资源类型及数量
   * 为系统优化提供数据支持
9. **保护和安全**
   * 确保资源访问受控
   * 防止系统受到外部攻击
   * 维护数据完整性和隐私

## 2.2 操作系统的用户接口

### 2.2.1 命令解释程序

命令解释程序(Command Interpreter)主要功能是获取并执行用户指定的命令，通常也称为Shell。

#### 命令接口类型

1. **脱机控制方式**
   * 用户通过作业控制说明书提交控制要求
   * 系统按照作业说明书规定控制作业执行
   * 用户不能直接干预运行过程
   * 适合批处理系统
2. **联机控制方式**
   * 用户通过键盘命令与系统交互
   * 实时控制程序执行
   * 用户可以立即获得反馈
   * 适合交互式系统

#### 联机命令分类

* **内部命令** ：
  * 功能简单、程序短小、使用频繁
  * 系统启动时就加载到内存并常驻
  * 例如：dir、cd、copy等(Windows系统)
* **外部命令** ：
  * 功能复杂、程序较长
  * 以独立文件形式存在于磁盘
  * 需要时才从磁盘调入内存
  * 例如：format、fdisk等(Windows系统)

**相关习题：**

* **问题** ：操作系统提供给编程人员的接口是_____。
* **答案** ：A. 系统调用。系统调用是操作系统提供给程序员的接口，允许应用程序请求操作系统服务。
* **问题** ：下列选项中，操作系统提供给应用程序的接口是____。
* **答案** ：A. 系统调用。系统调用是操作系统提供给应用程序的接口，应用程序通过系统调用请求操作系统服务。

### 2.2.2 图形用户接口(GUI)

* 基于鼠标的窗口和菜单系统
* 通过直接操作屏幕上的图形对象来控制程序
* 减少用户记忆负担，直观易用
* 操作方式从"记忆并键入"变为"选择并点取"
* 可视为命令接口的图形化表现

## 2.3 系统调用

### 系统调用概述

* 系统调用是程序与操作系统之间的接口
* 是由若干条指令构成的过程，用以实现特定的操作系统服务功能
* 也称为广义指令，由操作系统提供的子程序模块实现

### 参数传递方式

1. **寄存器传递** ：直接通过CPU寄存器传递参数
2. **表格传递** ：参数存储在内存的表格中，表格地址通过寄存器传递
3. **栈传递** ：程序将参数压入栈，操作系统从栈中获取参数

### 系统调用处理过程

1. **准备阶段** ：保存当前程序状态(现场保护)，将系统调用参数放入指定存储单元
2. **执行阶段** ：根据系统调用编号找到对应子程序入口地址并执行
3. **返回阶段** ：恢复程序状态(现场恢复)，将系统调用结果放入指定存储单元

### 系统调用与普通过程调用的区别

1. **运行状态不同** ：系统调用在核心态(特权模式)运行，普通过程调用在用户态运行
2. **进入方式不同** ：系统调用通过中断机制进入以改变运行状态，普通过程调用直接调用无需状态转换

**相关习题：**

* **问题** ：什么是系统调用的目的？
* **答案** ：系统调用的目的是提供操作系统服务的接口，允许用户程序请求操作系统执行特权操作，如I/O操作、文件管理、进程控制等。

### 系统调用类型

1. **进程控制**
   * 创建/终止进程
   * 等待/唤醒事件
   * 分配/释放内存
   * 加载/执行程序
2. **文件管理**
   * 创建/删除文件
   * 打开/关闭文件
   * 读/写文件
   * 获取文件信息
3. **设备管理**
   * 请求/释放设备
   * 读/写设备
   * 设备控制操作
4. **信息维护**
   * 获取/设置时间日期
   * 获取系统配置信息
   * 获取进程信息
5. **通信**
   * 创建/删除通信连接
   * 发送/接收消息
   * 管理通信状态

## 2.4 系统服务

系统服务是在系统调用基础上构建的更高级应用程序，它们提供了程序开发和执行的便利环境。

### 系统服务类型

1. **文件操作** ：文件管理工具，如文件浏览器
2. **状态信息** ：提供系统状态、性能数据等
3. **文件修改** ：文本编辑器、格式转换器等
4. **程序语言支持** ：编译器、解释器、调试器
5. **程序加载和执行** ：程序加载器、运行时环境
6. **通信** ：邮件客户端、网络管理工具等

多数用户实际接触的是这些应用和系统程序，而非直接使用系统调用。

## 2.5 Windows架构概述

Windows操作系统采用了分层架构设计，主要包括以下几个层次：

1. **硬件抽象层(HAL)** ：提供硬件接口，隔离硬件差异
2. **内核层** ：提供低级系统功能，如中断处理、进程调度
3. **Executive层** ：实现主要系统服务，如内存管理、I/O管理
4. **子系统层** ：提供不同应用环境支持
5. **用户应用层** ：用户程序和应用

Windows程序遵循事件驱动模型，处理消息循环是Windows应用程序的核心任务。

## 2.8 操作系统结构

操作系统作为大型软件系统，其内核结构主要有以下几种组织方式：

### 2.8.1 简单结构

* 典型代表：早期的MS-DOS、初代UNIX
* 特点：
  * 结构不清晰，功能层次没有明确划分
  * 所有组件紧密耦合
  * 初期规模小而简单，但随着功能扩展变得复杂难以维护

#### MS-DOS结构

* 目标是在最小空间提供最多功能
* 不划分模块，接口和功能层次不清晰
* 应用程序可以直接访问基本I/O例程，绕过系统调用接口

#### 早期UNIX结构

* 由两个独立部分组成：系统程序和内核
* 内核包含物理硬件之上、系统调用之下的所有功能
* 提供文件系统、CPU调度、内存管理等基础服务

### 2.8.2 分层方法(层次结构)

* 将操作系统划分为若干层(级)
* 最底层(0层)为硬件，最高层为用户接口
* 每层只能使用更低层提供的功能和服务
* 每层向上隐藏一定的实现细节

#### 层次结构特点

* 是一种特殊的模块结构
* 优点：
  * 调用关系有序，结构清晰
  * 易于理解和调试
  * 某层可以在上下两层不变的情况下被替换，有利于移植和扩展
* 缺点：
  * 牺牲了一定的灵活性
  * 性能开销较大(跨层调用累积延迟)
  * 设计难度大，各层功能划分不易

### 2.8.3 微内核结构

* 将非基本功能从内核移出，实现为系统或用户程序
* 内核只保留最基本功能：进程调度、内存管理、进程间通信
* 其他服务(如文件系统、设备驱动)在用户空间实现

#### 微内核特点

* 优点：
  * 易于扩展操作系统功能
  * 易于移植到不同硬件平台
  * 更安全可靠(服务故障不会直接导致内核崩溃)
  * 模块化程度高
* 缺点：
  * 系统服务间通信开销大，性能较低
  * 设计复杂度高

#### 典型代表

* Windows NT/2000系统属于微内核类型

### 2.8.4 模块结构

* 使用面向对象编程技术创建模块化内核
* 内核由一组核心组件和动态链接的附加服务构成
* 可在系统启动或运行时动态加载/卸载模块

#### 典型例子：Solaris模块组织

* 7种可加载内核模块+核心内核
  1. 调度类
  2. 文件系统
  3. 可加载系统调用
  4. 可执行格式
  5. STREAMS模块
  6. 杂项模块
  7. 设备和总线驱动

#### 模块结构特点

* 优点：
  * 效率高(直接调用，无需跨地址空间)
  * 灵活性好(可动态加载/卸载)
  * 扩展性好
* 缺点：
  * 全局函数使用多造成访问控制困难
  * 结构不如层次结构清晰
  * 可维护性和可移植性相对较差

### 宏内核与微内核比较

| 特性     | 宏内核(单内核)                     | 微内核                     |
| -------- | ---------------------------------- | -------------------------- |
| 运行方式 | 作为单一进程运行                   | 大部分内核模块作为独立进程 |
| 通信方式 | 直接函数调用                       | 消息传递                   |
| 内存布局 | 共享地址空间                       | 独立地址空间               |
| 性能     | 较高(无进程切换开销)               | 较低(有消息传递开销)       |
| 可靠性   | 较低(一个模块崩溃可能影响整个系统) | 较高(模块相对独立)         |
| 典型代表 | Linux                              | Windows NT/2000            |

## 小结

操作系统结构反映了系统设计的哲学和方法论，其演化体现了计算机科学对复杂系统组织的探索。从简单结构到层次结构，再到微内核和模块化结构，每种结构都有其特定的优缺点和适用场景。理解这些结构有助于我们更深入地理解操作系统的设计原理和实现方法。

现代操作系统通常采用混合结构，结合了多种结构的优点，以平衡灵活性、性能和可维护性等因素。例如，Linux虽然是宏内核，但采用了大量模块化设计；Windows则在微内核基础上加入了性能优化。

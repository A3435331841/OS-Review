# 第4章 线程 (Threads) 详解

## 4.1 概述

### 线程的基本概念

线程是操作系统中CPU使用的基本单元，是进程内的一个可执行单元。引入线程的目的主要有两个：

1. 减少程序并发执行所付出的时空开销
2. 使操作系统具有更好的并发性

### 进程的两个属性

进程具有两个重要属性：

1. **资源所有权单位** ：进程拥有虚拟地址空间、打开文件和I/O资源等
2. **调度和分派的基本单位** ：进程是CPU调度的最小单位

引入线程后，这两个属性被分开处理：

* **线程** （轻型进程）：作为调度和分派单位
* **进程** （任务）：作为资源所有权单位

### 线程的定义

线程包含以下基本组成部分：

* 线程标识（Thread ID）
* 程序计数器（Program Counter）
* 寄存器集（Register Set）
* 栈（Stack）

线程与同一进程中的其他线程共享：

* 代码段（Code Section）
* 数据段（Data Section）
* 其他操作系统资源

更通俗的定义：

* 线程是进程内的一个执行单元
* 线程是进程内的一个可调度实体
* 线程是程序（或进程）中相对独立的一个控制流序列
* 线程是进程内一个相对独立的、可调度的执行单元

### 线程拥有的资源

线程自身拥有的资源非常少，主要包括：

* 执行状态（Execution State）
* 线程上下文（Thread Context）
* 执行栈（Execution Stack）
* 线程静态存储局部变量（Per-thread Static Storage）
* 寄存器（Register）
* 对所属进程资源的访问权限

### 线程的状态

线程状态与进程类似，包括：

* **创建** ：当创建一个新进程时，也为该进程创建了一个线程；线程也可以创建新线程
* **就绪** ：线程已获得除处理机外的所有资源
* **运行** ：线程正在处理机上执行
* **阻塞** ：线程因等待某事件而暂停运行
* **终止** ：线程已完成执行

线程的同步与通信机制与进程类似，但进程的挂起及终止将影响其中的所有线程。

## 4.1.2 线程的优点

引入线程具有以下优势：

1. **响应能力强** ：即使程序的一部分被阻塞，其他部分仍可继续运行。例如，一个多线程的Web浏览器可以在下载大文件的同时，仍然允许用户与界面交互。
2. **资源共享** ：同一进程内的线程共享进程的资源，包括代码段、数据段和打开的文件等。这使得线程间通信更为简便高效。
3. **经济性** ：

* 创建和终止线程比创建和终止进程所需时间更少
* 同一进程内的线程切换比进程切换更快
* 由于同一进程内的线程共享内存和文件，它们之间的通信不需要调用内核

1. **多处理器体系结构的利用** ：在多处理器系统中，不同线程可以在不同处理器上并行执行，提高系统的吞吐量。

## 4.3 多线程模型

操作系统中支持线程的方式主要有：

1. **内核线程** （Kernel Threads）
2. **用户线程** （User Threads）
3. 两种方法的组合实现

### 内核线程（Kernel Threads）

* 也称为 **内核级线程** （kernel-level thread）
* 由操作系统内核完成创建和撤销工作
* 内核维护进程和线程的上下文信息并完成线程切换
* 一个内核线程阻塞时不会影响其他线程的运行
* 处理机时间直接分配给线程，有多个线程的进程将获得更多处理机时间

 **支持内核线程的系统示例** ：Windows系列、Solaris、Linux、Tru64 UNIX、BeOS等

### 用户线程（User Threads）

* 也称为 **用户级线程** （user-level thread）
* 不依赖于操作系统内核
* 由应用进程利用线程库提供的函数来创建、同步、调度和管理
* 线程的维护由应用进程完成
* 可用于不支持内核线程的操作系统
* 当一个线程阻塞时，整个进程都必须等待
* 处理机时间是分配给进程的，每个线程的执行时间相对更少

 **支持用户线程的库示例** ：POSIX Pthreads、Mach C-threads、Solaris threads

### 两种方法的组合实现

一些系统提供了内核线程和用户线程的组合实现：

* 内核支持多线程的建立、调度与管理
* 同时提供线程库，允许用户应用程序建立、调度和管理用户线程
* 这种方式很好地结合了内核线程和用户线程的优点

## 用户线程与内核线程的关系

用户线程与内核线程之间存在三种映射关系：

### 4.3.1 多对一模型（Many-to-One Model）

* 将多个用户线程映射到一个内核线程
* 线程管理在用户空间进行，效率较高
* **缺点** ：一个用户线程阻塞会导致整个进程阻塞
* **示例** ：Green threads（Solaris 2的线程库）

### 4.3.2 一对一模型（One-to-One Model）

* 将每个用户线程映射到一个内核线程
* 提供了更好的并发性，一个线程阻塞不会影响其他线程
* **缺点** ：大多数实现限制了系统支持的线程数量，因为创建太多内核线程会影响系统性能
* **示例** ：Windows 95/98/NT/2000、OS/2

### 4.3.3 多对多模型（Many-to-Many Model）

* 将多个用户线程多路复用到同样数量或更少数量的内核线程上
* 开发者可以创建任意多的用户线程
* 内核线程可以并行运行在多处理器系统上
* 结合了多对一和一对一模型的优点，避免了它们的缺点
* **示例** ：Solaris 2、Windows NT/2000、IRIX、HP-UX、Tru64 UNIX

## 线程与进程的比较

1. **调度** ：

* 传统OS中：进程是调度和分配资源的基本单位
* 引入线程后：线程是调度和分派的基本单位，进程是拥有资源的基本单位

1. **拥有资源** ：

* 进程是拥有资源的基本单位，由一个或多个线程及相关资源构成

1. **并发性** ：

* 进程之间可以并发执行
* 同一进程中的各线程之间也可以并发执行

1. **系统开销** ：

* 进程创建、撤销及切换的开销大于线程
* 同一进程的线程间同步与通信开销小

## 知识点练习与答案

### 练习题4.6

问：创建线程时使用什么资源？它们与创建进程时使用的资源有何不同？

答：

* 创建线程时使用的资源：线程ID、程序计数器、寄存器集、栈
* 创建进程时使用的资源：除了线程拥有的资源外，还包括代码段、数据段、堆内存、打开的文件和其他操作系统资源
* 主要区别：线程只需要少量的资源，而进程需要分配大量资源

### 练习题4.10

问：多线程进程中，以下哪些程序状态组件在线程间共享？
a. 寄存器值
b. 堆内存
c. 全局变量
d. 栈内存

答：

* b和c (堆内存和全局变量) 在线程间共享
* a和d (寄存器值和栈内存) 是每个线程私有的

### 选择题

问：关于线程和进程，下列说法中正确的是____。
A. 线程一定是分配处理机时间的基本单位
B. 进程一定是分配处理机时间的基本单位
C. 一个线程可以属于多个进程
D. 一个进程可以拥有多个线程

答：D (一个进程可以拥有多个线程)

### 填空题

问：在操作系统中引入线程概念的主要目的是_____。

答：减少程序并发执行所付出的时空开销，使操作系统具有更好的并发性。

### 考研题1

问：在支持多线程的系统中，进程P创建的若干个线程不能共享的是____。
A. 进程P的代码段
B. 进程P中打开的文件
C. 进程P的全局变量
D. 进程P中某线程的栈指针

答：D (进程P中某线程的栈指针)
解释：线程的栈指针是线程私有的，每个线程有自己的栈空间。而代码段、打开的文件和全局变量都是所有线程共享的。

### 考研题2

问：下列关于进程和线程的叙述中，正确的是（）
A. 不管系统是否支持线程，进程都是资源分配的基本单位
B. 线程是资源分配的基本单位，进程是调度的基本单位
C. 系统级线程和用户级线程切换都需要内核的支持
D. 同一进程的各个线程拥有各自不同的地址空间

答：A (不管系统是否支持线程，进程都是资源分配的基本单位)
解释：

* B错误：线程是调度的基本单位，进程是资源分配的基本单位
* C错误：用户级线程切换不需要内核支持
* D错误：同一进程内的线程共享相同的地址空间
